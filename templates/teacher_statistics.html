{% extends "base.html" %}

{% block title %}Statistics Report - R.E.A.C.H{% endblock %}

{% block content %}
<div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1 class="dashboard-title"><i class="bi bi-graph-up"></i> Statistics Report</h1>
        <div style="color: var(--text-secondary);">
            Grade {{ teacher.handling_grade }}, Section {{ teacher.handling_section }}
        </div>
    </div>
    <button onclick="window.print()" class="btn-print"><i class="bi bi-printer-fill"></i> Print Report</button>
</div>

<!-- Main Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
        <div class="stat-content">
            <div class="stat-label">Total Students</div>
            <div class="stat-value">{{ statistics.total_students }}</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-chat-dots-fill"></i></div>
        <div class="stat-content">
            <div class="stat-label">Total Consultations</div>
            <div class="stat-value">{{ statistics.total_consultations }}</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
        <div class="stat-content">
            <div class="stat-label">Pending</div>
            <div class="stat-value">{{ statistics.pending_consultations }}</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-eye-fill"></i></div>
        <div class="stat-content">
            <div class="stat-label">Read</div>
            <div class="stat-value">{{ statistics.read_consultations }}</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
        <div class="stat-content">
            <div class="stat-label">Responded</div>
            <div class="stat-value">{{ statistics.responded_consultations }}</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
        <div class="stat-content">
            <div class="stat-label">Avg per Student</div>
            <div class="stat-value">{{ statistics.avg_consultations }}</div>
        </div>
    </div>
</div>

<!-- Detailed Stats -->
<div class="stats-details-grid">
    <div class="card">
        <div class="card-header">Engagement Summary</div>
        <div class="stat-detail-row">
            <span>Students with Consultations:</span>
            <strong>{{ statistics.students_with_consultations }} / {{ statistics.total_students }}</strong>
        </div>
        <div class="stat-detail-row">
            <span>Students without Consultations:</span>
            <strong>{{ statistics.students_without_consultations }}</strong>
        </div>
        <div class="stat-detail-row">
            <span>Engagement Rate:</span>
            <strong>{{ (statistics.students_with_consultations / statistics.total_students * 100)|round(1) if statistics.total_students > 0 else 0 }}%</strong>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">Consultation Status Breakdown</div>
        <div class="status-bar">
            {% if statistics.total_consultations > 0 %}
                <div class="status-segment pending" 
                     style="width: {{ (statistics.pending_consultations / statistics.total_consultations * 100)|round(1) }}%;"
                     title="Pending: {{ statistics.pending_consultations }}">
                </div>
                <div class="status-segment read" 
                     style="width: {{ (statistics.read_consultations / statistics.total_consultations * 100)|round(1) }}%;"
                     title="Read: {{ statistics.read_consultations }}">
                </div>
                <div class="status-segment responded" 
                     style="width: {{ (statistics.responded_consultations / statistics.total_consultations * 100)|round(1) }}%;"
                     title="Responded: {{ statistics.responded_consultations }}">
                </div>
            {% else %}
                <p style="text-align: center; color: var(--text-secondary);">No consultations yet</p>
            {% endif %}
        </div>
        <div class="status-legend">
            <div><span class="legend-dot pending"></span> Pending: {{ statistics.pending_consultations }}</div>
            <div><span class="legend-dot read"></span> Read: {{ statistics.read_consultations }}</div>
            <div><span class="legend-dot responded"></span> Responded: {{ statistics.responded_consultations }}</div>
        </div>
    </div>
</div>

<!-- Student Consultation Details -->
<div class="card">
    <div class="card-header">Student Consultation Activity</div>
    {% if student_stats %}
    <table class="stats-table">
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Grade/Section</th>
                <th>Consultations</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in student_stats %}
            <tr>
                <td>{{ stat.student.full_name() }}</td>
                <td>Grade {{ stat.student.grade }}, Section {{ stat.student.section }}</td>
                <td>
                    <span class="consultation-badge">{{ stat.consultation_count }}</span>
                </td>
                <td>
                    {% if stat.consultation_count == 0 %}
                        <span class="status-label inactive">No Activity</span>
                    {% elif stat.consultation_count == 1 %}
                        <span class="status-label active">Active</span>
                    {% else %}
                        <span class="status-label very-active">Highly Active</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"><i class="bi bi-people"></i></div>
        <p>No students assigned yet.</p>
    </div>
    {% endif %}
</div>

<!-- Consultation History with Type Filter -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <span>Consultation History</span>
        <div style="display: flex; gap: 0.5rem;">
            <select id="consultationType" class="form-select" style="padding: 0.5rem; border-radius: 0.5rem; border: 2px solid var(--border); cursor: pointer; max-width: 200px;">
                <option value="">All Types</option>
                <option value="Academic">Academic</option>
                <option value="Emotional">Emotional</option>
                <option value="Behavioral">Behavioral</option>
                <option value="Family">Family</option>
                <option value="Personal">Personal</option>
            </select>
        </div>
    </div>
    {% if consultations %}
    <ul class="consultation-list" id="consultationList">
        {% for consultation in consultations|sort(attribute='created_at', reverse=true) %}
        <a href="{{ url_for('view_consultation', consultation_id=consultation.id) }}" style="text-decoration: none; color: inherit;" class="consultation-link" data-type="{{ consultation.subject.split('-')[0].strip() if '-' in consultation.subject else consultation.subject.split()[0] }}">
            <li class="consultation-item {{ consultation.status }}">
                <div class="consultation-header">
                    <div>
                        <div class="consultation-subject">{{ consultation.subject }}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">
                            Student: {{ consultation.student.full_name() }}
                        </div>
                    </div>
                    <span class="consultation-status status-{{ consultation.status }}">
                        {{ consultation.status }}
                    </span>
                </div>
                <div class="consultation-meta">
                    <span>ðŸ“… {{ consultation.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                </div>
            </li>
        </a>
        {% endfor %}
    </ul>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ’¬</div>
        <p>No consultations yet.</p>
    </div>
    {% endif %}
</div>

<!-- Additional Info Card -->
<div class="card">
    <div class="card-header">Teacher Information</div>
    <p><strong>Name:</strong> {{ teacher.full_name() }}</p>
    <p><strong>Handling:</strong> Grade {{ teacher.handling_grade }}, Section {{ teacher.handling_section }}</p>
    <p><strong>Total Sections:</strong> {{ statistics.unique_sections }}</p>
</div>

<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('teacher_dashboard') }}" class="btn-primary"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: #667eea;
        border-radius: 0.75rem;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: white;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card:nth-child(2) {
        background: #f5576c;
    }
    
    .stat-card:nth-child(3) {
        background: #ff6b6b;
    }
    
    .stat-card:nth-child(4) {
        background: #ffd43b;
    }
    
    .stat-card:nth-child(5) {
        background: #51cf66;
        color: white;
    }
    
    .stat-card:nth-child(6) {
        background: #ff9a56;
    }
    
    .stat-icon {
        font-size: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .stat-content {
        flex: 1;
    }
    
    .stat-label {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-bottom: 0.25rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .stats-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .stat-detail-row:last-child {
        border-bottom: none;
    }
    
    .status-bar {
        display: flex;
        height: 30px;
        background: #f0f0f0;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .status-segment {
        transition: opacity 0.2s;
    }
    
    .status-segment.pending {
        background: #ff6b6b;
    }
    
    .status-segment.read {
        background: #ffd43b;
    }
    
    .status-segment.responded {
        background: #51cf66;
    }
    
    .status-segment:hover {
        opacity: 0.8;
    }
    
    .status-legend {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        font-size: 0.9rem;
    }
    
    .legend-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 0.5rem;
        vertical-align: middle;
    }
    
    .legend-dot.pending {
        background: #ff6b6b;
    }
    
    .legend-dot.read {
        background: #ffd43b;
    }
    
    .legend-dot.responded {
        background: #51cf66;
    }
    
    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .stats-table thead {
        background: #f8f9fa;
    }
    
    .stats-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .stats-table td {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .stats-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .consultation-badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .status-label {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-label.inactive {
        background: #f1f3f5;
        color: #868e96;
    }
    
    .status-label.active {
        background: #d3f9d8;
        color: #2b8a3e;
    }
    
    .status-label.very-active {
        background: #ffe066;
        color: #856404;
    }
    
    .btn-primary {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        text-decoration: none;
        transition: background 0.2s;
    }
    
    .btn-primary:hover {
        background: #5568d3;
    }
    
    .btn-primary i {
        margin-right: 0.5rem;
    }
    
    .btn-print {
        background: #51cf66;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-print:hover {
        background: #40c057;
    }
    
    .btn-print i {
        font-size: 1.1rem;
    }
    
    @media print {
        .dashboard-header {
            display: block !important;
        }
        
        .btn-print {
            display: none !important;
        }
        
        .btn-primary {
            display: none !important;
        }
        
        body {
            padding: 20px;
        }
        
        .stat-card {
            page-break-inside: avoid;
        }
        
        .card {
            page-break-inside: avoid;
        }
        
        .stats-table {
            page-break-inside: avoid;
        }
        
        .stats-table tbody tr:hover {
            background: white;
        }
    }
</style>

<script>
// Consultation type filtering
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('consultationType');
    const consultationLinks = document.querySelectorAll('.consultation-link');
    
    typeSelect.addEventListener('change', function() {
        const selectedType = this.value.toLowerCase();
        let visibleCount = 0;
        
        consultationLinks.forEach(link => {
            const consultationType = link.getAttribute('data-type').toLowerCase();
            
            if (selectedType === '' || consultationType.includes(selectedType)) {
                link.style.display = 'block';
                visibleCount++;
            } else {
                link.style.display = 'none';
            }
        });
        
        // Show "no results" message if no consultations match
        const consultationList = document.getElementById('consultationList');
        const noResultsMsg = document.getElementById('noResultsMsg');
        
        if (visibleCount === 0) {
            if (!noResultsMsg) {
                const msg = document.createElement('div');
                msg.id = 'noResultsMsg';
                msg.style.cssText = 'text-align: center; color: var(--text-secondary); padding: 2rem;';
                msg.innerHTML = '<p>No consultations found for this type.</p>';
                consultationList.parentElement.appendChild(msg);
            }
        } else {
            if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
    });
});
</script>

{% endblock %}
